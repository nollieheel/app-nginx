# Generated by Chef.
# Changes will be overwritten.
#
server {
    listen 80;
<% if @server_name -%>
    server_name <%= @server_name %>;
<% end -%>
<% if @doc_root -%>
    root <%= @doc_root %>;
<% end -%>
<% if @index -%>
    index <%= @index %>;
<% end -%>

<%
## @res_headers = Hash of headers to be included in http response
##                Defaults shown below:
res_headers = @res_headers || {
  'Strict-Transport-Security'         => '"max-age=15758000;"',
  'X-Frame-Options'                   => 'SAMEORIGIN',
  'X-Content-Type-Options'            => 'nosniff',
  'X-XSS-Protection'                  => '"1; mode=block"',
  'X-Permitted-Cross-Domain-Policies' => 'none'
}
-%>
<% res_headers.each do |header, value| -%>
    add_header <%= header %> <%= value %>;
<% end -%>

<% if @auth -%>
    auth_basic "<%= @auth[:msg] %>";
    auth_basic_user_file <%= @auth[:path_pass] %>;

<% end -%>
<%
ldir = @log_dir || node['nginx']['log_dir']
-%>
    access_log <%= ldir %>/<%= @server_name || 'test' %>.access.log;
    error_log <%= ldir %>/<%= @server_name || 'test' %>.error.log;

<%
## @deny_locations = Array of location names to be set to 'deny all'
##                   Defaults below:
-%>
<% ( @deny_locations || ['~ (^|/)\.'] ).each do |loc| -%>
    location <%= loc %> {
        deny all;
        log_not_found off;
        access_log off;
    }

<% end -%>
<%
## @nolog_locations = Array of location names that are not to logged
##                    if accessed. Defaults below:
-%>
<% ( @nolog_locations || ['= /favicon.ico', '= /robots.txt'] ).each do |loc| -%>
    location <%= loc %> {
        log_not_found off;
        access_log off;
    }

<% end -%>
<%
## @handle_static_files = Array of file extensions that will be
##                        silently handled by Nginx
##                        Set to boolean false to disable.
unless @handle_static_files == false
  static_files = @handle_static_files || [
    'js',   'css', 'ogg', 'ogv', 'svg',  'svgz', 'eot', 'otf',
    'woff', 'mp4', 'ttf', 'rss', 'atom', 'jpg',  'jpeg', 'gif',
    'png',  'ico', 'zip', 'tgz', 'gz',   'rar',  'bz2', 'doc',
    'exe',  'ppt', 'tar', 'mid', 'midi', 'wav',  'bmp', 'rtf', 'xls'
  ]
-%>
    location ~* ^/.+\.(?:<%= static_files.join('|') %>)$ {
        expires max;
        log_not_found off;
        access_log off;
    }

<% end -%>
<%
## @other_locations = Additional location directives to add.
##                    Set here the main location directives.
##                    Useful also for whenever new Wordpress plugins are 
##                    installed and require some webserver config/restrictions.
-%>
<% ( @other_locations || [] ).each do |oloc| -%>
<%   if oloc.has_key?(:comment) -%>
    ## <%= oloc[:comment] %>
<%   end -%>
    location <%= oloc[:location] %> {
<%   oloc[:directives].each do |x| -%>
        <%= x %>;
<%   end -%>
    }

<% end -%>
    location / {
        return 200 'A webserver test';
        default_type text/plain;
    }
<% ## Additional Nginx directives. -%>
<% ( @others || [] ).each do |other| -%>
    <%= other %>;
<% end -%>
}
