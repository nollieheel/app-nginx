# Generated by Chef for <%= node['fqdn'] %>
# Do NOT modify this file by hand.
#

<% def nil_or_empty?(v) -%>
  <% (v.respond_to?(:nil?) && v.nil?) || (v.respond_to?(:empty?) && v.empty?) -%>
<% end -%>
<% unless nil_or_empty?(@maps) -%>
  <% @maps.each do |a| -%>
map <%= a[:source] %> <%= a[:target] %> {
    <% a[:mapping].each do |b| -%>
    <%= b[:key] %> '<%= b[:val] %>';
    <% end -%>
}

  <% end -%>
<% end -%>
<% unless nil_or_empty?(@upstreams) -%>
  <% @upstreams.each do |a| -%>
upstream <%= a[:name] %> {
    <% a[:servers].each do |b| -%>
    server <%= b %>;
    <% end -%>
}

  <% end -%>
<% end -%>
server {
    listen 80 deferred;

    charset utf-8;
    server_name <%= @server_name || node['fqdn'] %>;
    root <%= @root_dir || '/var/www/server' %>;

    access_log /var/log/nginx/<%= @log_filename || 'server' %>.access.log;
    error_log /var/log/nginx/<%= @log_filename || 'server' %>.error.log;

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location ~ (^|/)\. {
        deny all;
    }

<% # Do not really do this. Better to hardcode -%>
<% # your location blocks onto the template -%>
<% unless nil_or_empty?(@locations) -%>
  <% @locations.each do |a| -%>
    location <%= a[:location_string] %> {
    <% a[:statements].each do |b| -%>
        <%= b %>;
    <% end -%>
    }

  <% end -%>
<% end -%>
<% unless nil_or_empty?(@lb_ranges) -%>
  <% @lb_ranges.each do |a| -%>
    set_real_ip_from <%= a %>;
  <% end -%>

    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

<% end -%>
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Permitted-Cross-Domain-Policies none;

<% unless nil_or_empty?(@headers) -%>
  <% @headers.each do |k, v| -%>
    add_header <%= k %> <%= v %>;
  <% end -%>

<% end -%>
    client_max_body_size <%= @client_max_body_size %>;
    keepalive_timeout <%= @keepalive_timeout %>;
<% unless nil_or_empty?(@others) -%>

  <% @others.each do |a| -%>
    <%= a %>;
  <% end -%>
<% end -%>
}
